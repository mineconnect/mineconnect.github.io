permissions:
  contents: read
  pages: write
  id-token: write


name: Deploy MineConnect SAT - Dual Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm install
      env:
        # Ensure the npm install uses the provided secrets if needed (not strictly required but safe)
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

    - name: Build React App
      run: npm run build
      env:
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        VITE_SUPABASE_FUNCTIONS_URL: ${{ secrets.VITE_SUPABASE_FUNCTIONS_URL }}
      
    - name: Debug build output
      run: |
        echo "üìÅ Contents of dist directory:"
        ls -la dist/
        echo ""
        echo "üìÑ Contents of dist/index.html:"
        head -20 dist/index.html

    - name: Create final deploy structure
      run: |
        # Create final deploy directory
        mkdir -p final-deploy/sat
        
        # Copy built files to the deployment subdirectory
        echo "üìÅ Moving dist to final-deploy/sat/"
        cp -r dist/. final-deploy/sat/
        
        # Ensure PWA assets (manifest and icons) are included under the sat/ path
        echo "üîé Ensuring PWA assets are included in sat/"
        if [ -f dist/manifest.json ]; then
          cp dist/manifest.json final-deploy/sat/
        elif [ -f public/manifest.json ]; then
          cp public/manifest.json final-deploy/sat/
        fi
        for icon in pwa-192x192.png pwa-512x512.png vite.svg; do
          if [ -f dist/$icon ]; then
            cp dist/$icon final-deploy/sat/
          elif [ -f public/$icon ]; then
            cp public/$icon final-deploy/sat/
          fi
        done
        # Optional extra static assets from public/dist if present
        for f in pwa-styles.css; do
          if [ -f dist/$f ]; then cp dist/$f final-deploy/sat/; fi
        done
        
        # Copy CNAME if exists
        if [ -f CNAME ]; then
          echo "üåê Copying CNAME"
          cp CNAME final-deploy/
        fi
        
        # Add .nojekyll for GitHub Pages
        touch final-deploy/.nojekyll
        touch final-deploy/sat/.nojekyll
        
        # Ensure a root index.html exists that redirects to /sat/index.html (explicit file)
        echo '<!doctype html><html><head><meta http-equiv="refresh" content="0; url=/sat/index.html"></head><body></body></html>' > final-deploy/index.html
        # Create CNAME at root of final-deploy (domain for Pages)
        echo "mineconnect.com.ar" > final-deploy/CNAME

    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest

    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest

    - name: Deploy Edge Function
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_TOKEN }}
        PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_REF }}
      if: ${{ env.SUPABASE_ACCESS_TOKEN != '' && env.PROJECT_ID != '' }}
      run: |
        supabase functions deploy create_user --project-ref ${{ env.PROJECT_ID }}

    - name: Setup Pages
      uses: actions/configure-pages@v3

    - name: Verify final structure before upload
      run: |
        echo "üîç Final verification before upload:"
        echo "üìÅ final-deploy contents:"
        find final-deploy -type f | sort
        echo ""
        echo "üì± Checking sat/ directory:"
        ls -la final-deploy/sat/
        echo ""
        echo "üîç Checking for critical files:"
        [ -f final-deploy/sat/index.html ] && echo "‚úÖ sat/index.html exists" || echo "‚ùå sat/index.html MISSING"
        [ -f final-deploy/sat/manifest.json ] && echo "‚úÖ sat/manifest.json exists" || echo "‚ùå sat/manifest.json MISSING"

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./final-deploy

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      if: github.ref == 'refs/heads/main'
