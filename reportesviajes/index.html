<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Reportes de viajes — MineConnect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base href="/reportesviajes/">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#fff;--fg:#111;--muted:#555;--line:#ddd;}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);max-width:880px;margin:28px auto;padding:0 16px}
    h1{margin:.2rem 0 .6rem}
    p.small{margin:.2rem 0 1.2rem;color:var(--muted)}
    form{display:grid;gap:12px}
    fieldset{border:1px solid var(--line);padding:12px;border-radius:10px}
    legend{padding:0 6px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:grid;gap:6px}
    input,textarea,select,button{font:inherit;padding:10px;border:1px solid #ccc;border-radius:10px}
    select{background:#fff}
    textarea{resize:vertical}
    button{cursor:pointer;border:0}
    .primary{background:#111;color:#fff}
    .msg{padding:10px;border-radius:10px;display:none}
    .ok{background:#e7f7ee}
    .err{background:#fde8e8}
  </style>
</head>
<body>
  <h1>Reportes de viajes</h1>
  <p class="small">Completá el formulario para registrar un viaje.</p>

  <form id="f" novalidate>
    <fieldset>
      <legend>Datos del viaje</legend>

      <div class="row">
        <label>Fecha
          <input type="date" name="fecha" required>
        </label>

        <label>Chofer
          <select name="chofer" id="selChofer" required></select>
          <input type="text" id="otroChofer" placeholder="Especificar chofer" style="display:none;margin-top:6px">
        </label>
      </div>

      <div class="row">
        <label>Vehículo / Patente
          <select name="vehiculo" id="selVehiculo" required></select>
          <input type="text" id="otroVehiculo" placeholder="Especificar vehículo/patente" style="display:none;margin-top:6px">
        </label>

        <label>Pasajeros
          <input type="number" name="pasajeros" min="0" step="1" value="0">
        </label>
      </div>

      <div class="row">
        <label>Origen
          <select name="origen" id="selOrigen" required></select>
          <input type="text" id="otroOrigen" placeholder="Especificar origen" style="display:none;margin-top:6px">
        </label>

        <label>Destino
          <select name="destino" id="selDestino" required></select>
          <input type="text" id="otroDestino" placeholder="Especificar destino" style="display:none;margin-top:6px">
        </label>
      </div>

      <div class="row">
        <label>KM inicio
          <input type="number" name="kmInicio" min="0" step="0.1" required>
        </label>
        <label>KM fin
          <input type="number" name="kmFin" min="0" step="0.1" required>
        </label>
      </div>

      <div class="row">
        <label>Combustible (L o $)
          <input type="text" name="combustible" placeholder="35 L / $25.000">
        </label>
        <label>Peajes ($)
          <input type="number" name="peajes" min="0" step="0.01" value="0">
        </label>
      </div>

      <label>Observaciones
        <textarea name="observaciones" rows="3" placeholder="Incidencias, desvíos, etc."></textarea>
      </label>

      <label>Adjuntos (URLs, separadas por coma)
        <input type="text" name="adjuntos" placeholder="https://... , https://...">
      </label>
    </fieldset>

    <!-- honeypot anti-bots -->
    <input type="text" name="empresa" style="display:none">

    <div class="row">
      <button class="primary" type="submit">Enviar reporte</button>
      <button type="reset">Limpiar</button>
    </div>

    <div id="ok" class="msg ok">¡Reporte enviado! ✅</div>
    <div id="err" class="msg err">Hubo un error. Intenta nuevamente.</div>
  </form>

  <script>
    // ========= Configuración Supabase =========
    const SUPABASE_URL = 'https://ztzzllzohdvknijxvorl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0enpsbHpvaGR2a25panh2b3JsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NTI1MjAsImV4cCI6MjA3MDQyODUyMH0.0ty2Qq9K9USUvdCjq8lw-KHTYkTGCESQHMMjuYAPJJ8';
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ========= Listas para selects (editables) =========
    const LIST_CHOFERES  = ["Facundo Marengo", "Juan Pérez", "María Gómez", "Otro…"];
    const LIST_VEHICULOS = ["Hilux - XYZ123", "Sprinter - ABC456", "Ranger - JKL789", "Otro…"];
    const LIST_ORIGENES  = ["Base Galán", "Campamento", "Planta", "Ciudad", "Otro…"];
    const LIST_DESTINOS  = ["Base Galán", "Campamento", "Planta", "Ciudad", "Otro…"];

    function fillSelect(id, items){
      const sel = document.getElementById(id);
      sel.innerHTML = "";
      items.forEach(v=>{
        const opt = document.createElement("option");
        opt.value = v; opt.textContent = v;
        sel.appendChild(opt);
      });
    }
    fillSelect("selChofer",   LIST_CHOFERES);
    fillSelect("selVehiculo", LIST_VEHICULOS);
    fillSelect("selOrigen",   LIST_ORIGENES);
    fillSelect("selDestino",  LIST_DESTINOS);

    function hookOtro(selectId, inputId){
      const sel = document.getElementById(selectId);
      const inp = document.getElementById(inputId);
      const toggle = () => {
        if (sel.value === "Otro…") { inp.style.display = "block"; inp.required = true; }
        else { inp.style.display = "none"; inp.required = false; inp.value = ""; }
      };
      sel.addEventListener("change", toggle);
      toggle();
    }
    hookOtro("selChofer","otroChofer");
    hookOtro("selVehiculo","otroVehiculo");
    hookOtro("selOrigen","otroOrigen");
    hookOtro("selDestino","otroDestino");

    // ========= Envío =========
    const f = document.getElementById('f');
    const ok = document.getElementById('ok');
    const err = document.getElementById('err');

    const buildPayload = () => {
      const form = new FormData(f);

      const choose = (selId, otroId) => {
        const selVal = document.getElementById(selId).value;
        if (selVal === "Otro…") return (document.getElementById(otroId).value || "").trim();
        return selVal;
      };

      return {
        fecha: form.get('fecha'),
        chofer: choose("selChofer","otroChofer"),
        vehiculo: choose("selVehiculo","otroVehiculo"),
        pasajeros: Number(form.get('pasajeros')||0),
        origen: choose("selOrigen","otroOrigen"),
        destino: choose("selDestino","otroDestino"),
        km_inicio: Number(form.get('kmInicio')),
        km_fin: Number(form.get('kmFin')),
        combustible: (form.get('combustible')||'').trim(),
        peajes: Number(form.get('peajes')||0),
        observaciones: (form.get('observaciones')||'').trim(),
        adjuntos: (form.get('adjuntos')||'').trim()
      };
    };

    f.addEventListener('submit', async (e) => {
      e.preventDefault(); ok.style.display='none'; err.style.display='none';

      // honeypot
      const hp = (new FormData(f).get('empresa')||'').trim();
      if (hp) return;

      const payload = buildPayload();

      if (!payload.fecha || !payload.chofer || !payload.vehiculo || !payload.origen || !payload.destino) {
        err.textContent = 'Faltan campos obligatorios.'; err.style.display='block'; return;
      }
      if (payload.km_fin < payload.km_inicio) {
        err.textContent = 'KM fin no puede ser menor que KM inicio.'; err.style.display='block'; return;
      }

      const { error } = await supabase.from('viajes').insert(payload);
      if (error) { err.textContent = 'Error: ' + error.message; err.style.display='block'; return; }

      ok.style.display='block';
      f.reset();
      // Restablecer selects tras reset
      fillSelect("selChofer",   LIST_CHOFERES);
      fillSelect("selVehiculo", LIST_VEHICULOS);
      fillSelect("selOrigen",   LIST_ORIGENES);
      fillSelect("selDestino",  LIST_DESTINOS);
    });
  </script>
</body>
</html>
