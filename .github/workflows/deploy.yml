name: Deploy MineConnect SAT - Dual Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build React App
      run: npm run build
      env:
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

    - name: Create final deploy structure
      run: |
        # Create final deploy directory
        mkdir -p final-deploy
        
        # Copy React App build to sat/ subdirectory
        mkdir -p final-deploy/sat
        cp -r dist/* final-deploy/sat/
        
        # Copy root static files (landing page)
        if [ -f index.html ]; then
          cp index.html final-deploy/
        fi
        
        # Copy images and other static files from public directory
        find public -maxdepth 1 -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.svg" -o -name "*.ico" | while read file; do
          cp "$file" final-deploy/
        done
        
        # Copy CNAME if exists
        if [ -f CNAME ]; then
          cp CNAME final-deploy/
        fi
        
        # Copy manifest.json if exists
        if [ -f manifest.json ]; then
          cp manifest.json final-deploy/
        fi
        
        # Add .nojekyll for GitHub Pages
        touch final-deploy/.nojekyll
        touch final-deploy/sat/.nojekyll
        
        # List final structure
        echo "Final deploy structure:"
        find final-deploy -type f | head -20

    - name: Setup Pages
      uses: actions/configure-pages@v3

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: ./final-deploy

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2
      if: github.ref == 'refs/heads/main'

permissions:
  contents: write
  pages: write
  id-token: write